<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VideoTC 销量管理（Excel版）</title>
  <!-- 引入 SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      padding: 20px;
      background-color: #f9f9f9;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    input, select, button {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      background: #4CAF50;
      color: white;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #45a049;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #f2f2f2;
      cursor: pointer;
      user-select: none;
    }
    th:hover {
      background-color: #e9e9e9;
    }
    .actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .import-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    .file-input {
      display: none;
    }
    .file-label {
      display: inline-block;
      padding: 8px 16px;
      background: #2196F3;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }
    .file-label:hover {
      background: #1976D2;
    }
    .status {
      margin-top: 10px;
      padding: 8px;
      border-radius: 4px;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <div class="container">
    <h1>VideoTC 销量数据看板（Excel版）</h1>

    <!-- 筛选区 -->
    <div class="filters">
      <input type="text" id="filter-product" placeholder="产品ID" />
      <input type="date" id="filter-start-date" />
      <input type="date" id="filter-end-date" />
      <select id="sort-order">
        <option value="">销量排序</option>
        <option value="asc">销量 ↑</option>
        <option value="desc">销量 ↓</option>
      </select>
      <button onclick="fetchSales()">查询</button>
    </div>

    <!-- 数据表格 -->
    <table id="sales-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>产品ID</th>
          <th>日期</th>
          <th>销量</th>
        </tr>
      </thead>
      <tbody id="sales-body"></tbody>
    </table>

    <!-- 操作按钮 -->
    <div class="actions">
      <button onclick="exportToXLSX()">导出 Excel</button>
      <label class="file-label" for="xlsx-file">导入 Excel</label>
      <input type="file" id="xlsx-file" class="file-input" accept=".xlsx,.xls" />
    </div>

    <div id="status-message"></div>

    <!-- 导入说明 -->
    <div class="import-section">
      <p><strong>Excel 格式要求：</strong> 第一行必须包含列名，且包含以下三列（顺序不限）：</p>
      <ul>
        <li><code>product_id</code></li>
        <li><code>date_str</code>（格式：YYYY-MM-DD）</li>
        <li><code>sales</code>（整数）</li>
      </ul>
      <p>示例：</p>
      <table border="1" cellpadding="5">
        <tr><th>product_id</th><th>date_str</th><th>sales</th></tr>
        <tr><td>1111</td><td>2025-11-30</td><td>10</td></tr>
        <tr><td>2222</td><td>2025-12-01</td><td>10</td></tr>
      </table>
    </div>
  </div>

  <script>
    const API_BASE = 'http://120.78.0.22:9999';
    let allSales = [];

    async function fetchSales() {
      try {
        const product = document.getElementById('filter-product').value.trim();
        const startDate = document.getElementById('filter-start-date').value;
        const endDate = document.getElementById('filter-end-date').value;

        let url = `${API_BASE}/sales/`;
        const params = new URLSearchParams();
        if (product) params.append('product_id', product);
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
        if (params.toString()) url += '?' + params.toString();

        const res = await fetch(url);
        if (!res.ok) throw new Error('获取数据失败');
        allSales = await res.json();
        renderTable(allSales);
      } catch (err) {
        showMessage('加载数据失败: ' + err.message, 'error');
      }
    }

    function renderTable(data) {
      const tbody = document.getElementById('sales-body');
      const sortOrder = document.getElementById('sort-order').value;

      if (sortOrder === 'asc') data.sort((a, b) => a.sales - b.sales);
      else if (sortOrder === 'desc') data.sort((a, b) => b.sales - a.sales);

      tbody.innerHTML = data.map(item => `
        <tr>
          <td>${item.id}</td>
          <td>${item.product_id}</td>
          <td>${item.date_str}</td>
          <td>${item.sales}</td>
        </tr>
      `).join('');
    }

    // 导出为 Excel (.xlsx)
    function exportToXLSX() {
      if (allSales.length === 0) {
        showMessage('没有数据可导出', 'error');
        return;
      }

      //
